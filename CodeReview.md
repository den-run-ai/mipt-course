**Оглавление:**


---


# Перед тем как начать... #
**Внимательно прочитайте _всю_ страницу перед тем, как делать _что-либо_; в том числе рекомендации в конце.**

Предполагается, что у Вас уже есть SVN клиент и Вы умеете собирать наш проект.<br>Если это не так, <a href='http://code.google.com/p/mipt-course/wiki/Building'>читайте соответствующую инструкцию</a>.<br>
<br>
Убедитесь, что Ваш svn-клиент использует <code>https://</code>:<br>
<pre><code>$ svn info | grep URL  # выполнять в папке SVN-клиента.<br>
URL: https://mipt-course.googlecode.com/svn/trunk<br>
</code></pre>
Если это не так - см. внизу страницы.<br>
<br>
Если на строке URL у Вас видно https - читайте далее.<br>
<br>
<hr />
<h1>Процесс шаг за шагом</h1>
<i>Действующие лица - Автор патча и Ревьювер.</i>

<h2>1. Подготовка патча</h2>
Автор патча:<br>
<ul><li>Убеждается, что его SVN клиент использует протокол https (см выше)<br><br>
</li><li>Если патч делается в рамках семестрового задания - нужно завести bug/issue (далее "тикет" - дабы не было путаницы с <i>code review issue</i>).<br><br>
</li><li><a href='http://code.google.com/p/mipt-course/wiki/SubversionPlayground'>Делает в SVN клиенте нужные изменения</a>,<br>в том числе <code>svn add/rm/mv</code> на новые/удаляемые/переименованные файлы.<br>Особых действий с изменёнными (уже существовавшими в репозитории) файлами делать не надо.<br><br>
</li><li>Проверяет свои файлы на стилистические ошибки при помощи<br>
<pre><code>./cpplint.py &lt;список всех изменённых файлов&gt;<br>
</code></pre>
</li></ul><blockquote>и исправляет обнаруженные недочеты.</blockquote>

<blockquote>Также, не мешало бы собрать и запустить все тесты.</blockquote>

<h2>2. Отправка патча</h2>
Автор патча:<br>
<ul><li>Загружает файлы для code review на сайт codereview.appspot.com :<br>
<pre><code># ВАЖНО: Вызывайте данную команду из корневой директории вашего svn клиента, а не из подпапок вроде sandbox/!<br>
./upload.py &lt;список ВСЕХ изменённых файлов&gt;<br>
# Если спросит пароль - ввести GMail-пароль<br>
New issue subject: Я исправил багу такую-то, см. issue 42  # пишете сюда краткое описание патча - что сделано?<br>
</code></pre>
</li></ul><blockquote><b>Cкрипт распечатает ссылку на ревью</b>, например <a href='http://codereview.appspot.com/1234567'>http://codereview.appspot.com/1234567</a>.<br>Число в конце ссылки - номер ревью, его хорошо бы куда-нибудь записать.</blockquote>

<ul><li>Открывает страницу ревью, и проверяет, что там оказались именно те файлы и те изменения, которые он хотел совершить<br>(не больше, не меньше! без отладочных printf и т.п.)<br>
</li></ul><blockquote>Если Автор понимает, что надо что-то исправить - исправляет и загружает новый патч той же командой, но с дополнительным флагом <code>i</code> :<br>
<pre><code>./upload &lt;список_файлов&gt; -i 1234567<br>
</code></pre>
(при желании можно создать новый review и удалить старый).<br>
</blockquote><ul><li>По адресу <a href='http://codereview.appspot.com/1234567/edit'>http://codereview.appspot.com/1234567/edit</a> в поле Description указывает:<br>
<ul><li>Что собственно сделано, на что смотреть в ревью<br>
</li><li>Ссылку на issue, к которому относится ревью.<br>
</li><li>Если это может быть неочевидно Ревьюверу, то также команды как проверить что делает патч (например, команды CMake+make для проверки изменения в CMakeLists.txt), на какие тесты обратить внимание и т.д.<br>
</li></ul></li><li>Итак, когда патч проверен самостоятельно, можно отправлять его Ревьюверу.<br>Автор нажимает "<b>Publish+Mail Comments</b>" (m)<br>Там указывается e-mail Ревьювера, в поле <i>Message</i> пишется просьба сделать review.<br>По нажатию "<b>Publish All My Drafts</b>" - Ревьюверу отправится письмо.<br>// <b>TODO(timurrrr): кого добавлять в cc</b><br><br></li></ul>

<h2>3. Собственно, code review</h2>
<ul><li><del>Наступает ночь, просыпается мафия.</del><br><br>
</li><li>Ревьювер, получив письмо, пишет inline комментарии к патчу и таким же образом (Publish All My Drafts) посылает письмо Автору патча с просьбой исправить то-то и то-то.<br><br>
</li><li>Автор патча исправляет найденные ошибки, снова запускает все тесты, <code>./cpplint.py</code> и затем посылает обновлённый патч командой<br>
<pre><code>./upload.py &lt;список ВСЕХ изменённых файлов&gt; -i 1234567 # Важно указать номер review!<br>
# Даже если какие-то файлы из review не были изменены в новой версии патча по<br>
# сравнению со старой (но отличаются от ревизии HEAD), их все равно надо указать.<br>
</code></pre>
</li><li>Автор патча отвечает на все комментарии Ревьювера (хотя бы "Done") и посылает их ("Publish All My Drafts")<br><br>
</li><li>Ревьювер снова получает письмо, пишет комментарии и т.д. - до тех пор пока патч всех не устравивает.<br>
</li><li>Рекомендуется перед каждым <code>./upload.py</code> делать <code>svn up</code> и исправить все конфликты локально, чтобы этого не делал Ревьювер, пробуя Ваш патч.</li></ul>

<h2>4. Review пройден - что дальше?</h2>
<ul><li>Когда Ревьювера всё устраивает - он говорит LGTM (<i>Looks Good To Me</i>).<br><i>Уточнение: Ревьюверов бывает несколько.</i><br>В этом случае Автору патча стоит прямым текстом спрашивать,<br>стоит ли ждать LGTM от всех или достаточно одного/двух.<br>Логика обычно такая:<br>Если каждый ревьювер компетентен во всем коде, который ты меняешь - достаточно одного LGTM.<br>Если каждый ревьювер ответственен только за свой кусок - нужно LGTM от всех.<br>
</li><li>Перед commit'ом Автор проверяет, что добавит в репозиторий именно то, что необходимо с помощью<br>
<pre><code>svn diff &lt;список изменённых файлов&gt; | less  # выйти из леса - q<br>
# Заодно проверьте, что список файлов совпадает с прошедшим ревью.<br>
</code></pre>
</li><li>Автор commit'ит патч в репозиторий командой<br>
<pre><code># Обратите внимание - кавычка закрывается только на последней строке; не пропускайте пустую строку!<br>
svn commit &lt;список ВСЕХ изменённых файлов&gt; -m "&lt;Описание изменения&gt;.<br>
Reviewed at http://codereview.appspot.com/1234567<br>
<br>
Update issue &lt;номер_тикета&gt;<br>
Сделано то-то и то-то,<br>
следующий шаг - то-то и то-то"<br>
</code></pre>
</li></ul><blockquote>или<br>
<pre><code>svn commit &lt;тот же список изменённых файлов&gt;<br>
# дождаться открытия редактора $SVN_EDITOR и там написать:<br>
&lt;Описание изменения&gt;.<br>
Reviewed at http://codereview.appspot.com/1234567<br>
<br>
Update issue &lt;номер_тикета&gt;<br>
Сделано то-то и то-то,<br>
следующий шаг - то-то и то-то<br>
</code></pre>
Ссылка на review указывается для истории - там видно и кто делал review, и какие вопросы обсуждались, и т.п.</blockquote>

<blockquote>Благодаря строке <code>"Update issue XYZ"</code> в ваш тикет будет автоматически добавлена ссылка на коммит, а также последующий текст.<br>(Пример: см <a href='https://code.google.com/p/mipt-course/issues/detail?id=49'>issue 49</a> vs <a href='https://code.google.com/p/mipt-course/source/detail?r=470'>r470</a>, а также <a href='http://code.google.com/p/support/wiki/IssueTracker#Integration_with_version_control'>документацию</a>).<br /><b>Если SVN спрашивает у Вас пароль, надо ввести не GMail-пароль, а тот, что сгенерирован на странице <a href='https://code.google.com/hosting/settings'>https://code.google.com/hosting/settings</a></b>
<h2>5. Завершение процесса после коммита</h2>
</blockquote><ul><li>Через пару минут после коммита <b>настоятельно рекомендуется</b> проверить, что данный патч успешно прошел сборку и запуск на <a href='http://ubermipt.com:8080/waterfall'>билдботе</a> (а также см e-mail на предмет гневных писем "ааа Вы сломали сборку/тесты!").<br>Если на боте что-то пошло не так (код не компилируется, тесты фейлятся и т.д.) - рекомендую сделать <a href='http://svnbook.red-bean.com/en/1.1/ch04s04.html#svn-ch-4-sect-4.2'>откат ревизии</a>:<br>
<pre><code>svn up &amp;&amp; svn status -q  # убедиться, что в клиенте нет локальных изменений<br>
REV=&lt;номер "плохой" ревизии&gt;  # например, REV=1234<br>
svn merge -r $REV:$((REV-1)) $(svn info | grep "^URL:" | gawk '{print $2}')<br>
# Получится svn merge -r 1234:1233 https://mipt-course.googlecode.com/svn/trunk<br>
svn commit -m "Revert rN - failed on the buildbot"<br>
</code></pre>
</li></ul><blockquote><b>TODO</b> - этот процесс можно улучшить, сделав на билдботе Commit Queue (см. <a href='https://code.google.com/p/mipt-course/issues/detail?id=17'>issue 17</a>)</blockquote>

<ul><li>Автор пишет в описании ревью "Закоммитил <code>http://code.google.com/p/mipt-course/source/detail?r=1234</code>" и "закрывает" review:<br><i>Edit issue (<a href='http://codereview.appspot.com/1234567/edit'>http://codereview.appspot.com/1234567/edit</a>) -> написать Description -> поставить галочку Closed -> Update Issue.</i><br><br>
</li><li>Если в commit message было указано "update issue XYZ", то стоит проверить что в тикете появилась запись о коммите.<br>Иначе, напишите соответствующий комментарий в тикет самостоятельно.<br>Например, <i>"ошибка исправлена в ревизии <a href='https://code.google.com/p/mipt-course/source/detail?r=10'>r10</a>", "фича сделана в <a href='https://code.google.com/p/mipt-course/source/detail?r=5'>r5</a>"</i> и т.п.<br><br>
</li><li>Настоятельно рекомендуется не удалять review issues - пусть для всех коммитов сохранится история что-кто-кому-писал при review.<br>
<hr /></li></ul>

<h1>Общие рекомендации</h1>
<ul><li>Чем меньше патч, тем проще Ревьюверу выполнить свою задачу и тем быстрее проходит ревью.<br>Если есть возможность разбить большой патч на несколько логически завершённых небольших патчей - лучше сразу так и поступить,<br><br>
</li><li>Экономьте время Ревьювера - не стоит посылать недоделанные и плохо форматированные патчи!<br>Перед отправкой патча на review <b>обязательно</b> проверьте, что код компилируется и проходит все тесты.<br>Проверьте Code Style с помощью <a href='http://google-styleguide.googlecode.com/svn/trunk/cppguide.xml#cpplint'>cpplint.py</a>.<br>В редких случаях допускается отправлять недоделанный код с явно выраженной в Message просьбой помочь советом/разобраться/доделать.<br><br>
</li><li>Если Вам непонятно что делать дальше (кажется, что все уже сделали), а Ревьювер не отвечает - напишите ему "Мне нужно еще что-то делать?". Возможно, Вы что-то не поняли или Ревьювер не понял, что ему нужно на что-то посмотреть.<br><br>
</li><li>Если что-то в этой инструкции непонятно - <a href='http://code.google.com/p/rietveld/wiki/CodeReviewHelp'>вот</a> оригинальная на английском.</li></ul>

<h1>Если все-таки SVN клиент настроен на http://</h1>
<i>Примечание:<br>
Раньше на сайте были инструкции по checkout как <code>http://</code>, так и <code>https://</code> версий.<br>
По идее, у студентов 2011-2012 года такой проблемы быть не должно, но на всякий случай сохраняю инструкцию по переносу.</i>

Если Вы по ошибке уже послали на review некий код из клиента с <code>http://</code> адресом - не отчаивайтесь, еще не все потеряно!<br>Создайте новый https-клиент и перенесите в него изменения с помощью команд<br>
<pre><code>svn diff &gt;~/http_client.patch  # Выполнять в http-клиенте<br>
cd ~/my_https_client<br>
patch -p0 -i ~/http_client.patch  # Выполнять в https-клиенте<br>
# или<br>
svn diff ~/my_http_client | patch -p0  # Выполнять в https-клиенте<br>
</code></pre>

Теперь снова сделайте <code>svn add</code> для всех добавленных файлов (в https-клиенте)<br>
Проверьте командой <code>svn status</code> что SVN знает обо всех Ваших новых файлах, потом проверьте что все собирается - и можно удалять старый <code>http</code> клиент.